<!doctype html>
<html class="no-js" lang="en">
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?9f5f07182d18acd1dafaf88997f1242a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
    
  奉强的个人博客
  
  </title>
 <meta name="description" content="奉强的技术博客，全栈开发。">
 <link href="atom.xml" rel="alternate" title="奉强的个人博客" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />

    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
    <script src="asset/highlightjs/highlight.pack.js"></script>
    <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
    <script>hljs.initHighlightingOnLoad();</script>
    
  </head>
  <body class="antialiased hide-extras">
    
    <div class="marketing off-canvas-wrap" data-offcanvas>
      <div class="inner-wrap">


<nav class="top-bar docs-bar hide-for-small" data-topbar>

<div id="header">
    <h1><a href="index.html">奉强的个人博客</a></h1>
</div>

</nav>
        <nav class="tab-bar show-for-small">
  <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
    <span> &nbsp; 奉强的个人博客</span>
  </a>
</nav>

<aside class="left-off-canvas-menu">
      <ul class="off-canvas-list">
      <li><a href="index.html">Home</a></li>
      
        <li class="divider"></li>
        <li><label>杂类</label></li>

          
            <li><a title="基于docker搭建lanproxy内网穿透服务" href="15229403526064.html">基于docker搭建lanproxy内网穿透服务</a></li>
          
            <li><a title="手摸手教程 之 教你搭建自己的静态博客" href="14993449096811.html">手摸手教程 之 教你搭建自己的静态博客</a></li>
          
            <li><a title="我的2016" href="14854433400635.html">我的2016</a></li>
          
            <li><a title="支付宝怎么免手续费提现" href="14786196059653.html">支付宝怎么免手续费提现</a></li>
          
            <li><a title="怎么用自己的域名建立一个个人博客" href="14607325165802.html">怎么用自己的域名建立一个个人博客</a></li>
          
            <li><a title="嵌入式和单片机的学习心得" href="14939112243125.html">嵌入式和单片机的学习心得</a></li>
          

      
        <li class="divider"></li>
        <li><label>iOS开发</label></li>

          
            <li><a title="iOS逆向开发笔记1--工具篇" href="14854248394653.html">iOS逆向开发笔记1--工具篇</a></li>
          
            <li><a title="Swift3入门教程之二----函数和闭包" href="14758321095435.html">Swift3入门教程之二----函数和闭包</a></li>
          
            <li><a title="Swift3入门教程之一基础部分" href="14758046879967.html">Swift3入门教程之一基础部分</a></li>
          
            <li><a title="iOS开发-如何优雅地集成支付宝支付功能" href="14702334322974.html">iOS开发-如何优雅地集成支付宝支付功能</a></li>
          
            <li><a title="iOS开发中，m3u8格式视频的下载缓存" href="14685880528825.html">iOS开发中，m3u8格式视频的下载缓存</a></li>
          
            <li><a title="git中，如何使用sourcetree管理同一个项目中的多个远程仓库" href="14634059724558.html">git中，如何使用sourcetree管理同一个项目中的多个远程仓库</a></li>
          
            <li><a title="iOS开发-坑爹的iOS特性" href="14611524452165.html">iOS开发-坑爹的iOS特性</a></li>
          
            <li><a title="iOS开发-打通UIWebView和WKWebView的Cookie" href="14611518603473.html">iOS开发-打通UIWebView和WKWebView的Cookie</a></li>
          
            <li><a title="iOS开发-apple pay的实际应用" href="14611508828436.html">iOS开发-apple pay的实际应用</a></li>
          
            <li><a title="iOS开发-navigationBar的透明度处理" href="14610809561335.html">iOS开发-navigationBar的透明度处理</a></li>
          
            <li><a title="iOS开发-AVPlayer的缓存问题" href="14608134723455.html">iOS开发-AVPlayer的缓存问题</a></li>
          
            <li><a title="iOS开发-OC可选参数函数" href="14608131201401.html">iOS开发-OC可选参数函数</a></li>
          
            <li><a title="iOS开发-FMDB多线程安全问题" href="14608133210368.html">iOS开发-FMDB多线程安全问题</a></li>
          

      
        <li class="divider"></li>
        <li><label>Python</label></li>

          
            <li><a title="一个导出qq音乐歌单的小工具" href="14913069118493.html">一个导出qq音乐歌单的小工具</a></li>
          
            <li><a title="Python学习笔记-函数的使用" href="14890625223406.html">Python学习笔记-函数的使用</a></li>
          
            <li><a title="Python学习笔记-基础篇" href="14695444360650.html">Python学习笔记-基础篇</a></li>
          

      
        <li class="divider"></li>
        <li><label>OpenCV</label></li>

          
            <li><a title="苍老师的 "码" 是怎么打上的" href="15090278092045.html">苍老师的 "码" 是怎么打上的</a></li>
          

      
      </ul>
    </aside>

<a class="exit-off-canvas" href="#"></a>

        <section id="main-content" role="main" class="scroll-container">

          <div class="row">
            <div class="large-3 medium-3 columns">
              <div class="hide-for-small">
                <div class="sidebar">
                <nav>
                  <ul id="side-nav" class="side-nav">

                    
                      <li class="side-title"><span>杂类</span></li>
                        
                          <li><a title="基于docker搭建lanproxy内网穿透服务" href="15229403526064.html">基于docker搭建lanproxy内网穿透服务</a></li>
                        
                          <li><a title="手摸手教程 之 教你搭建自己的静态博客" href="14993449096811.html">手摸手教程 之 教你搭建自己的静态博客</a></li>
                        
                          <li><a title="我的2016" href="14854433400635.html">我的2016</a></li>
                        
                          <li><a title="支付宝怎么免手续费提现" href="14786196059653.html">支付宝怎么免手续费提现</a></li>
                        
                          <li><a title="怎么用自己的域名建立一个个人博客" href="14607325165802.html">怎么用自己的域名建立一个个人博客</a></li>
                        
                          <li><a title="嵌入式和单片机的学习心得" href="14939112243125.html">嵌入式和单片机的学习心得</a></li>
                        

                    
                      <li class="side-title"><span>iOS开发</span></li>
                        
                          <li><a title="iOS逆向开发笔记1--工具篇" href="14854248394653.html">iOS逆向开发笔记1--工具篇</a></li>
                        
                          <li><a title="Swift3入门教程之二----函数和闭包" href="14758321095435.html">Swift3入门教程之二----函数和闭包</a></li>
                        
                          <li><a title="Swift3入门教程之一基础部分" href="14758046879967.html">Swift3入门教程之一基础部分</a></li>
                        
                          <li><a title="iOS开发-如何优雅地集成支付宝支付功能" href="14702334322974.html">iOS开发-如何优雅地集成支付宝支付功能</a></li>
                        
                          <li><a title="iOS开发中，m3u8格式视频的下载缓存" href="14685880528825.html">iOS开发中，m3u8格式视频的下载缓存</a></li>
                        
                          <li><a title="git中，如何使用sourcetree管理同一个项目中的多个远程仓库" href="14634059724558.html">git中，如何使用sourcetree管理同一个项目中的多个远程仓库</a></li>
                        
                          <li><a title="iOS开发-坑爹的iOS特性" href="14611524452165.html">iOS开发-坑爹的iOS特性</a></li>
                        
                          <li><a title="iOS开发-打通UIWebView和WKWebView的Cookie" href="14611518603473.html">iOS开发-打通UIWebView和WKWebView的Cookie</a></li>
                        
                          <li><a title="iOS开发-apple pay的实际应用" href="14611508828436.html">iOS开发-apple pay的实际应用</a></li>
                        
                          <li><a title="iOS开发-navigationBar的透明度处理" href="14610809561335.html">iOS开发-navigationBar的透明度处理</a></li>
                        
                          <li><a title="iOS开发-AVPlayer的缓存问题" href="14608134723455.html">iOS开发-AVPlayer的缓存问题</a></li>
                        
                          <li><a title="iOS开发-OC可选参数函数" href="14608131201401.html">iOS开发-OC可选参数函数</a></li>
                        
                          <li><a title="iOS开发-FMDB多线程安全问题" href="14608133210368.html">iOS开发-FMDB多线程安全问题</a></li>
                        

                    
                      <li class="side-title"><span>Python</span></li>
                        
                          <li><a title="一个导出qq音乐歌单的小工具" href="14913069118493.html">一个导出qq音乐歌单的小工具</a></li>
                        
                          <li><a title="Python学习笔记-函数的使用" href="14890625223406.html">Python学习笔记-函数的使用</a></li>
                        
                          <li><a title="Python学习笔记-基础篇" href="14695444360650.html">Python学习笔记-基础篇</a></li>
                        

                    
                      <li class="side-title"><span>OpenCV</span></li>
                        
                          <li><a title="苍老师的 "码" 是怎么打上的" href="15090278092045.html">苍老师的 "码" 是怎么打上的</a></li>
                        

                    
                  </ul>
                </nav>
                </div>
              </div>
            </div>
            <div class="large-9 medium-9 columns">

 


	
		<div class="markdown-body">
		<h1>iOS开发-如何优雅地集成支付宝支付功能</h1>

		<h3 id="toc_0">文档更新说明：</h3>

<pre><code>•   2016年08月03日 v1.0 初稿
</code></pre>

<h2 id="toc_1">前言</h2>

<p>这篇文章不是从0开始接入支付宝SDK的教程，因为支付宝官网的官方文档已经说得很清楚了，如果您是为了找一篇接入支付宝的教程，那么这里更适合你。<a href="https://doc.open.alipay.com/doc2/detail.htm?spm=a219a.7629140.0.0.qV9mLB&amp;treeId=59&amp;articleId=103675&amp;docType=1">支付宝集成流程详解</a>。</p>

<p>那么这篇文章到底要表达一点什么呢？其实也就一点关于支付宝接入的注意事项而已。</p>

<h3 id="toc_2">1、支付信息签名应该放在服务端还是客户端？</h3>

<p>支付宝对签名的要求是只要按照格式正确签名即可，那么这就有个问题了，我们应该把签名放在客户端还是服务器呢？从支付宝官网下载下来的demo也是把签名过程放在客户端的，很多人就会跟着在客户端做签名过程了，笔者以前也是这么做的。但是回头一想，签名过程在客户端，那也就是说需要把私钥放在客户端，这显然是很危险的，稍不留神就被别人逆向把私钥拿到了，给我们的支付安全引入了不必要的危险。</p>

<p>答案很明显，我们应该把签名流程放在服务器端。原因如下：</p>

<ul>
<li>1、保证私钥安全；</li>
<li>2、免得客户端要导入那么多签名用的第三方库；</li>
<li>3、支付宝官方文档上面说得很清楚。&quot;出于安全考虑，请商户尽量把私钥保存在服务端，在服务端进行签名验签。&quot;</li>
</ul>

<h3 id="toc_3">2、移动支付和手机网页支付有什么区别和联系？</h3>

<p>这两种支付方式是需要分别签约的，两者的支付权限是分开的。</p>

<ul>
<li>移动支付：接入SDK，通过支付宝的SDK来调起支付宝APP完成支付，如果用户没有安装支付宝APP，则打开H5支付页面；</li>
<li>手机网页支付：打开一个支付宝的H5支付页面，支付全程在H5页面上完成。</li>
</ul>

<p>看到这里，或许你会认为移动支付功能显然比手机网页支付强大，因为移动支付是可以在用户没安装支付宝的时候打开H5支付页面的。<br/>
实际上，手机网页支付也是可以调起APP来支付的，只要在网页支付请求参数里面加个app_pay=Y，然后支付宝就会在用户安装了支付宝APP的情况下调起支付宝APP来完成支付。<br/>
这样调是有一个缺陷的，就是用户完成或者取消支付的话，不能自动跳回我们自己的APP内。<br/>
<img src="media/14702334322974/14702335117009.jpg" alt=""/></p>

<h3 id="toc_4">3、怎么通过网页支付页面调起支付宝APP支付，并且在完成之后跳回我们自己的APP呢？</h3>

<p>这种支付集成方式应该是native开发者最喜欢的了吧。要达到这种效果，需要两个必要条件：</p>

<ul>
<li>1、已经开通了网页支付权限</li>
<li>2、已经开通了移动支付权限</li>
<li>3、用户手机内有安装支付宝APP</li>
</ul>

<h4 id="toc_5">3.1具体实现方式：</h4>

<ul>
<li>1、 实现UIWebViewDelegate协议，拦截H5的URL；</li>
<li>2、 调用SDK提供的“获取订单信息接口(fetchOrderInfoFromH5PayUrl)”对拦截的URL进行处理：</li>
</ul>

<pre><code class="language-oc">/**
 *  url order 获取接口
 *
 *  @param urlStr     拦截的 url string
 *
 *  @return 获取到的url order info
 */
- (NSString*)fetchOrderInfoFromH5PayUrl:(NSString*)urlStr;
</code></pre>

<ul>
<li>3、通过上面的方法，如果返回的字符串长度不为0，则说明这个链接是属于支付宝的支付链接，这时，调用支付接口，打开支付宝APP完成支付。</li>
</ul>

<pre><code class="language-oc">/**
 *  url支付接口
 *
 *  @param orderStr       订单信息
 *  @param schemeStr      调用支付的app注册在info.plist中的scheme
 *  @param compltionBlock 支付结果回调Block
 */
- (void)payUrlOrder:(NSString *)orderStr
         fromScheme:(NSString *)schemeStr
           callback:(CompletionBlock)completionBlock;
</code></pre>

<ul>
<li>例子：</li>
</ul>

<pre><code class="language-oc">- (BOOL)webView:(UIWebView *)webView shouldStartLoadWithRequest:(NSURLRequest *)request navigationType:(UIWebViewNavigationType)navigationType {
    NSString* orderInfo = [[AlipaySDK defaultService]fetchOrderInfoFromH5PayUrl:[request.URL absoluteString]];
    if (orderInfo.length &gt; 0) {
        // 调用支付接口进行支付
        [[AlipaySDK defaultService]payUrlOrder:orderInfo fromScheme:@&quot;alisdkdemo&quot; callback:^(NSDictionary* result) {
            // 处理返回结果
            NSString* resultCode = result[@&quot;resultCode&quot;];
            //建议操作: 根据resultCode做处理
 
            // returnUrl 代表 第三方App需要跳转的成功页URL
            NSString* returnUrl = result[@&quot;returnUrl&quot;];
            //建议操作: 打开returnUrl
        }];
 
        return NO;
    }
    return YES;
}
</code></pre>

<h2 id="toc_6">总结</h2>

<p>何为优雅？百度是这样解释的：优雅是一种和谐，类似于美丽，只不过美丽是上天的恩赐，而优雅是艺术的产物。<br/>
在编程中，用最少的代码实现最优秀的功能，这大概就是优雅吧。在本文中，如果我们能在网页端做到调用APP支付，那么对于APP开发者来说是多么优雅的编程方式，不超过20行代码就能完成支付宝的集成，并且还能在iOS、安卓和Web端复用这个支付网页。多么优雅~<br/>
这里再多说一句，吐槽一下微信的支付，还不支持H5方式的支付~</p>


		</div>
	

 
	

 
	

 
	

 
	

  
  
</div></div>


<div class="page-bottom">
<div class="row" style="text-align: center">
  <p>本文已在版权印备案，如需转载请访问版权印。</p>
  <span style="display:inline-block;width:111px;"><a style="float:left;text-decoration:none;" target="_blank" href="https://www.banquanyin.com/u/101707140007287"><img src="https://s1.banquanyin.com/c/icon-yin-32.png" title="更多授权" style="width:inherit;"></a><a target="_blank" href="https://101707140007287.bqy.mobi"><img src="https://s1.banquanyin.com/c/icon-auth-cr-32.png" title="获取授权" style="width:inherit;"></a></span>
</div>
  <div class="row">
  <hr />
  <div class="small-9 columns">
  <p class="copyright">Copyright &copy; 2017
奉强 Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
Theme used <a target="_blank" href="http://github.com">GitHub CSS</a>，<a target="_blank" href="http://www.miitbeian.gov.cn/">粤ICP备17007554号.</a></p>
  </div>
  <div class="small-3 columns">
  <p class="copyright text-right"><a href="#header">TOP</a></p>
  </div>
   
  </div>
</div>

        </section>
      </div>
    </div>
    
    
    <script src="asset/js/foundation.min.js"></script>
    <script src="asset/js/foundation/foundation.offcanvas.js"></script>
    <script>
      $(document).foundation();

     
    </script>
    <script src="asset/chart/all-min.js"></script><script type="text/javascript">$(function(){    var mwebii=0;    var mwebChartEleId = 'mweb-chart-ele-';    $('pre>code').each(function(){        mwebii++;        var eleiid = mwebChartEleId+mwebii;        if($(this).hasClass('language-sequence')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = Diagram.parse($(this).text());            diagram.drawSVG(eleiid,{theme: 'simple'});        }else if($(this).hasClass('language-flow')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = flowchart.parse($(this).text());            diagram.drawSVG(eleiid);        }    });});</script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({TeX: { equationNumbers: { autoNumber: "AMS" } }});</script>

  </body>
</html>
